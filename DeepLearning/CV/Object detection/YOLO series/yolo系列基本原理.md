# YOLO系列原理

利用深度学习进行目标检测的算法可分为两类：two-stage和one-stage。two-stage类的算法，是基于Region Proposal的，它包括R-CNN，Fast R-CNN, Faster R-CNN；one-stage类的算法仅仅使用一个CNN网络直接预测不同目标的类别与位置，它包括YOLO系列算法、SSD算法。two-stage类算法精度高，但速度慢，one-stage类算法速度快，但精度不如two-stage。

YOLO（You Only Look Once）凭借其实时性、不错的精度，在工业应用中发挥着巨大的作用，如无人驾驶、农作物病虫害预防、医学检查等。而且YOLO系列从提出至今已经迭代研发出了15个版本，不断地借鉴新的算法提高己身性能。

## 1.YOLOv1的基本原理

### 1.1 滑动窗口技术
滑动窗口技术就是采用不同大小和比例（宽高比）的窗口在整张图片上以一定的步长进行滑动，然后对这些窗口对应的区域做图像分类，这样就可以实现对整张图片的检测了。但是这有个致命的缺点，由于检测目标的大小未知，需要设置很多不同尺寸的窗口去滑动，这样会导致产生极多的无效区域，而且这些区域都需要经过分类器判断，计算量巨大。

YOLO摒弃了滑动窗口技术，直接将原始图片分割成 $s \times s$ 个互不重合的小方块，然后通过卷积最后产生 $s \times s$ 的特征图，可以认为特征图的每个元素对应原始图片的一个小方块（和视野域挺像的），然后用每个元素来预测那些中心点在该小方格内的目标，这就是YOlO系列算法的朴素思想。

![The schematic of YOLO](the%20schematic%20of%20yolo.png "The schematic of YOLO")
*Figure 1: The schematic of YOLO*

### 1.2 设计理念
YOLO的CNN网络将输入的图片分割成 $s \times s$ 的网格，然后每个单元格负责去检测那些中心落入其中的目标，最后该单元格会预测B（v1中B为2）个边界框（bounding box）以及边界框的置信度（confidence score）。备注：这就是YOLO系列的设计范式——逐网格查找；以下是针对v1版本对该范式的详细分析。对上面的话逐字阅读后，会产生以下疑问：

1. 怎么确认单元格是否对应目标？
   这是对网络进行训练的结果，可以看作是一个二分类，其结果记为 Pr(object)。假如我们的目标是狗、自行车、汽车，预测单元格cell1对应的目标是狗，则Pr(object)=1；预测单元格cell2不在目标之中，则Pr(object)=0。
2. 怎么确认边界框的大小与位置？
   边界框的大小与位置可以用4个值来表征： (x, y, w, h) ，其中 (x, y) 是边界框的中心坐标，而 w 和 h 是边界框的宽与高。还有一点要注意，中心坐标的预测值 (x, y) 是相对于每个单元格左上角坐标点的偏移值，并且单位是单元格大小。而边界框的 w 和 h 预测值是相对于整个图片的宽与高的比例，这样理论上4个元素的大小应该在 [0,1] 范围。如图3，图中边界框可以表征为（0.4, 0.6, 0.4, 0.8）。
   ![gridandboundingbox](gridandboundingbox.png "gridandboundingbox")
   *Figure 3: 网格划分及边界框示意图.*

3. 边界框的置信度

    所谓置信度其实包含两个方面，一是这个边界框含有目标的可能性大小，二是这个边界框的准确度。前者就是指边界框对应的单元格是否对应目标，其用Pr(object)表征，值为0和1。边界框的准确度可以用预测框与实际框（ground truth）的IOU（intersection over union，交并比）来表征，记为
    $$
    IOU=\frac{A \cap B}{A \cup B}
    $$

4. 含有目标的单元格类别
    给出每一个单元格预测C个类别的概率值，其表征的是由该单元格负责预测的边界框其目标属于各个类别的概率。
    直白来说，每个单元格只对应一个概率最高的类别（这个在v3及以后做了改变）。但是这些概率值其实是在各个边界框置信度下的条件概率，即Pr(classi|object)。<u>值得注意的是，不管一个单元格预测多少个边界框，其只预测一组类别概率值，这是Yolov1算法的一个缺点。</u> 同时，我们可以计算出各个边界框类别置信度（class-specific confidence scores）:
    $$
    Pr(classi|object)*Pr(classi)*IOU_{pred}^{truth} = Pr(class_i)*IOU_{pred}^{truth}
    $$

5. 总结
    边界框类别置信度表征的是该边界框中目标属于各个类别的可能性大小以及边界框匹配目标的好坏。一般会根据类别置信度使用NMS来过滤网络的预测框。注意和边界框置信度做区分，边界框置信度是对是否含有目标的表征，边界框类别置信度是对含有的目标类别的表征。