#cs #linux
# ssh命令

ssh 命令用于通过 SSH 协议连接到远程主机，实现远程登录和执行命令，它加密会话中的所有通信，确保数据传输的安全性。

SSH (Secure Shell) 是一种用于远程登录和其他网络服务之间的加密协议，SSH 提供了一个安全的通信渠道，以保护数据的机密性和完整性。

**语法：**
`ssh [options] [user@]hostname [command]`

**参数说明**
- `[user@]hostname`：要连接的远程主机的用户名和主机名。
- `[command]`：可选的在远程主机上执行的命令。

**常用选项**
- `-l user`：指定要登录的用户。
- `-p port`：指定连接到远程主机的端口号，默认是22。
- `-i identity_file`：指定身份验证文件（私钥文件）。
- `-v`：详细模式，可以显示调试信息。
- `-C`：启用压缩。
- `-N`：不执行远程命令，只进行端口转发。
- `-f`：后台运行。
- `-L local_port:remote_host:remote_port`：本地端口转发。
- `-R remote_port:local_host:local_port`：远程端口转发。
- `-D [bind_address:]port`：动态应用程序级端口转发。

## 实例

### 基本用法
- 连接到远程主机：
```
ssh user@hostname
```
示例：
```
ssh test@runoob.com
```
- 指定端口连接：
```
ssh -p 2222 user@hostname
```
示例：
```
ssh -p 2222 test@runoob.com
```
- 使用身份验证文件：
```
ssh -i /path/to/private_key user@hostname
```
示例：
```
ssh -i ~/.ssh/id_rsa test@runoob.com
```
- 在远程主机上执行命令：
```
ssh user@hostname command
```
示例：
```
ssh test@runoob.com ls -la
```
- 详细模式：
```
ssh -v user@hostname
```
示例：
```
ssh -v test@runoob.com
```
- 启用压缩：
```
ssh -C user@hostname
```
示例：
```
ssh -C test@runoob.com
```
- 后台运行且不执行命令：
```
ssh -f -N user@hostname
```
示例：
```
ssh -f -N test@runoob.com
```

---
### 端口转发
- 本地端口转发：
```
ssh -L local_port:remote_host:remote_port user@hostname
```
示例：
```
ssh -L 8080:localhost:80 test@runoob.com
```
- 远程端口转发：
```
ssh -R remote_port:local_host:local_port user@hostname
```
示例：
```
ssh -R 8080:localhost:80 test@runoob.com
```
- 动态端口转发：
```
ssh -D [bind_address:]port user@hostname
```
示例：
```
ssh -D 1080 test@runoob.com
```

---
### 高级用法

**配置文件**
SSH 客户端配置文件位于 ~/.ssh/config，可以在其中设置常用配置。
示例：
``` shell
Host example
    HostName example.com
    User john
    Port 2222
    IdentityFile ~/.ssh/id_rsa
```

使用时只需：
`ssh example`

**SSH 代理转发**
	启用代理转发：
	`ssh -A user@hostname`
	示例：
	`ssh -A test@runoob.com`

**X11 转发**
	启用 X11 转发：
	`ssh -X user@hostname`
	示例：
	`ssh -X test@runoob.com`



# SSH协议
SSH（Secure Shell，安全外壳）是一种网络安全协议，通过加密和认证机制实现安全的访问和文件传输等业务。

----
## SSH协议的用途
传统远程登录和文件传输方式，例如Telnet、FTP，使用明文传输数据，存在很多的安全隐患。随着人们对网络安全的重视，这些方式已经慢慢不被接受。SSH协议通过对网络数据进行加密和验证，在不安全的网络环境中提供了安全的网络服务。作为Telnet和其他不安全远程shell协议的安全替代方案，目前SSH协议已经被全世界广泛使用，大多数设备都支持SSH功能。

默认情况下，SSH服务器使用端口号22。

SSH 代表 Secure Shell，也称为 Secure Socket Shell。传统的互联网通信使用明文传输数据，内容一旦被截获就会完全暴露，存在很多安全隐患。SSH协议通过对网络数据进行加密和验证，建立SSH客户端和SSH服务器之间的安全隧道，在不安全的网络环境中为网络服务提供了安全的传输通道。
![[ssh连接.png]]
----
## SSH协议的工作过程
SSH由服务器和客户端组成，为建立安全的SSH通道，双方需要先建立TCP连接，然后协商使用的版本号和各类算法，并生成相同的会话密钥用于后续的对称加密。在完成用户认证后，双方即可建立会话进行数据交互。SSH的工作流程包括如下几个阶段。
![[ssh工作流.png]]

----
### 连接建立

SSH依赖端口进行通信。在未建立SSH连接时，SSH服务器会在指定端口侦听连接请求，SSH客户端向SSH服务器该指定端口发起连接请求后，双方建立一个TCP连接，后续会通过该端口通信。

-----
### 版本协商

SSH协议目前存在SSH1.X（SSH2.0之前的版本）和SSH2.0版本。SSH2.0协议相比SSH1.X协议来说，在结构上做了扩展，可以支持更多的认证方法和密钥交换方法，同时提高了服务能力。SSH服务器和客户端通过协商确定最终使用的SSH版本号，过程如下：
1. SSH服务器通过建立好的连接向SSH客户端发送支持的SSH版本信息。
2. SSH客户端收到版本信息后，根据自身支持的SSH版本决定使用的版本号，并将决定使用的版本号发送给SSH服务器。
3. SSH服务器判断自己是否支持客户端决定使用的版本号，从而确定版本协商是否成功。
----
### 算法协商

SSH工作过程中需要使用多种类型的算法，包括用于产生会话密钥的密钥交换算法、用于数据信息加密的对称加密算法、用于进行数字签名和认证的公钥算法和用于数据完整性保护的HMAC算法。SSH服务器和客户端对每种类型中具体算法的支持情况不同，因此双方需要协商确定每种类型中最终使用的算法，过程如下：
1. SSH服务器和客户端分别向对方发送自己支持的算法。
2. SSH服务器和客户端依次协商每种类型中具体使用的算法。在每类算法的协商过程中，SSH服务器和客户端都会匹配出双方均支持的算法作为最终使用的算法。每类算法均匹配成功后，算法协商完成。如果某类算法全部匹配失败，则该类型的算法协商失败，这会导致SSH服务器和客户端之间算法协商失败并断开连接。
----
### 密钥交换
SSH服务器和客户端通过密钥交换算法，动态生成共享的会话密钥和会话ID，建立加密通道。会话密钥主要用于后续数据传输的加密，会话ID用于在认证过程中标识该SSH连接。在该阶段也会完成客户端对服务器的身份认证，服务器先使用服务器私钥对消息进行签名，客户端再使用服务器公钥验证签名，从而完成客户端对服务器的身份认证。

由于SSH服务器和客户端需要持有相同的会话密钥用于后续的对称加密，为保证密钥交换的安全性，SSH使用一种安全的方式生成会话密钥，由SSH服务器和客户端共同生成会话密钥，利用数学理论巧妙地实现不直接传递密钥的密钥交换，无需通过不安全通道传送该密钥，具体过程如下图所示。
![[ssh密钥.png]]
SSH密钥交换
1. SSH服务器生成素数G、P、服务器私钥b，并计算得到服务器公钥y=(G^b)%P。
2. SSH服务器将素数G、P、服务器公钥y发送给SSH客户端。
3. SSH客户端生成客户端私钥a，计算得到客户端公钥x=(G^a)%P。
4. SSH客户端将客户端公钥x发送给SSH服务器。
5. SSH服务器计算得到对称密钥K=(x^b)%P，SSH客户端计算得到对称密钥K=(y^a)%P，数学定律可以保证SSH服务器和SSH客户端生成的对称密钥相同。

----
### 用户认证
SSH客户端向SSH服务器发起认证请求，SSH服务器对SSH客户端进行认证。SSH支持以下几种认证方式：
- **密码（password）认证**：客户端通过用户名和密码的方式进行认证，将加密后的用户名和密码发送给服务器，服务器解密后与本地保存的用户名和密码进行对比，并向客户端返回认证成功或失败的消息。
- **密钥（publickey）认证**：客户端通过用户名、公钥以及公钥算法等信息来与服务器进行认证。
- **password-publickey认证**：指用户需要同时满足密码认证和密钥认证才能登录。
- all认证：只要满足密码认证和密钥认证其中一种即可
SSH用户认证最基本的两种方式是密码认证和密钥认证。密码认证的基本原理是SSH客户端使用对称密钥对密码进行加密，SSH服务器使用对称密钥解密后验证密码的合法性，这种认证方式比较简单，且每次登录都需要输入用户名和密码。而密钥认证可以实现安全性更高的免密登录，基本原理是SSH客户端使用客户端私钥对消息进行签名，服务器再使用客户端公钥验证签名，这是一种广泛使用且推荐的登录方式。

----
### 会话请求

认证通过后，SSH客户端向服务器发送会话请求，请求服务器提供某种类型的服务，即请求与服务器建立相应的会话。服务器根据客户端请求进行回应。

---
### 会话交互

会话建立后，SSH服务器端和客户端在该会话上进行数据信息的交互，双方发送的数据均使用会话密钥进行加解密。

----
## SSH和SSL的区别

SSH和[SSL](https://info.support.huawei.com/info-finder/encyclopedia/zh/SSL.html "SSL")都是网络安全协议，通过加密和认证提升两台设备间传输数据的安全性。但SSH和SSL的生效方式和服务目标存在差异。

SSH在两台设备间创建安全隧道，使这两台设备间可以安全地发送命令、传输数据等。例如，客户端通过SSH远程登录到一台服务器上，就可以安全地远程管理这台服务器，在服务器上执行想要的命令。

SSL则是使用SSL证书保证两台设备间安全地传输数据，而不是像SSH那样可以执行命令。例如，用户通过浏览器访问某安装了SSL证书且启用了HTTPS的服务器，浏览器和服务器之间可以安全地传输数据。

SSH就像一辆汽车，我们看不到这辆封闭的汽车里装载的是什么。而SSL就像一个封闭的集装箱，我们可以用不同的交通工具运输它，但看不到集装箱里装的是什么。