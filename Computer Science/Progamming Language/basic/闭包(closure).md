# 闭包（Closure）

## 概念理解
**闭包（Closure）**又称**词法闭包（Lexical Closure）**或**函数闭包（function closures）**，是在支持头等函数的编程语言中实现词法绑定的一种技术。

闭包是引用了**自由变量**的函数。这个被引用的自由变量将和这个函数一同存在，即使已经离开了创造它的环境也不例外。  

<font color=yellow>**自由变量**：</font> 在函数外部定义但在函数内被引用

有另一种说法认为<u>闭包是由函数和与其相关的引用环境组合而成的实体。</u>

另一种解释：<u>闭包通常用于创建函数工厂，即返回函数的函数。当外部函数返回内部函数时，内部函数会保留对外部函数作用域的引用，形成闭包。 </u> 

闭包是为了解决 **自由变量（free variable）** 的问题，<u>即在函数内部的变量，可以在函数外被访问和调用。 </u>

闭包是一种函数，它会保留定义时存在的自由变量的绑定，这样调用函数时，虽然定义作用域不可用了，但是仍然能使用那些绑定。通过闭包的方式，就可以实现这个功能。    

## 闭包的实现
闭包在实现上是一个结构体，它存储了一个函数（通常是其入口地址）和一个关联的环境（相当于一个符号查找表）。环境里是若干对符号和值的对应关系，它既要包括约束变量（该函数内部绑定的符号），也要包括自由变量（在函数外部定义但在函数内被引用），有些函数也可能没有自由变量。

闭包跟函数最大的不同在于，当捕捉闭包的时候，它的自由变量会在捕捉时被确定，这样即便脱离了捕捉时的上下文，它也能照常运行。捕捉时对于值的处理可以是值拷贝，也可以是名称引用，这通常由语言设计者决定，也可能由用户自行指定（如C++）。


## 在Python中
闭包（closure）是指一个函数（通常称为内部函数），它包含对在其外部函数中定义的非全局变量的引用。 

<u> Python不要求声明变量，而是假定在函数定义体中赋值的变量是局部变量。 </u>

### Python 中的作用域
闭包允许内部函数访问其外部函数的作用域，即使外部函数已经执行完毕。 

闭包的作用是通过返回一个内部函数的方式，保留了对自由变量的绑定，解决了自由变量访问的问题，这样可以自啊不使用global关键字的情况下，访问外部函数定义的局部变量。 

在内部函数内赋值会将自由变量定义为内部函数的局部变量，为了解决这个问题，Python3引入了<font color=red>nonlocal关键字 </font> 声明，nonlocal的作用是<u>把变量标记为自由变量</u>，即使在函数中为变量赋值了，也仍然是自由变量。  

## 总结
闭包就是用来解决函数嵌套时，自由变量如何处理的问题，它会保留自由变量的绑定，即使局部作用域已经消失。  

对于不可变类型和None来说，<u>赋值会隐式创建局部变量，把自由变量转换为局部变量， </u> 
这可能会导致程序报错：局部变量在赋值前进行了引用。  

除了使用global声明为全局变量外，还可以<u>使用nonlocal声明把局部变量强制变为自由变量</u>，实现闭包。  



