
# 问题分析
现有数据：
1. 风速、风向，温度、湿度等气象数据
2. 控制向量的参数， 一个向量，目前是十个元素，后续会增加。
3. 输出的矩阵（30 * 44）

输入x1（气象数据，主要是风速，风向）, x2（控制向量） 

输出y， 散布矩阵

# 模型设计

## 1. 先做风序列的“物理感知”特征
（无论用什么模型都受益）
- **时域统计**（在 1s、5s、10s、全窗口等多时间尺上计算）
    - 均值 $\bar u,\bar v$、标准差、偏度、峰度、最大/最小、**阵风因子** $G=\frac{u_{\max}}{\bar u}$
        
- **频域/时频特征**
    - STFT/小波能量分布、主频、带宽、1/f 比例、不同频段能量占比
        
- **方向对齐**
    - 以“平均风向”为 x 轴，把风与地面坐标对齐，有助于让模型**旋转不变**。数据增强可对 (X,Y) 做共同旋转。

## 2. 建模，端到端：**序列到热力图**
把 100 秒风速序列当作时序，控制向量当作条件，直接输出 $H\times W$ 热力图。
	
- **结构**（简化示意）
	1. **时序编码**：Transformer Encoder（或双向 LSTM）处理 `[T,2]` 得到全局向量 $z_t$​（加位置编码）
	2. **参数编码**：液体参数经 MLP 得到 $z_p$​
	3. **融合**：$[z_t; z_p]$ 通过 MLP → 低维潜变量 $z$
	4. **解码到平面**：小型 **U‑Net** 或 转置卷积，把 $z$ 先映射到一个低分辨率特征图，再上采样到 $H\times W$
		
- **输出与约束**
	- 激活：**Softplus** 保证非负
	- **质量归一化层**：$\hat M = M/\sum M \times V$（使总量等于液体体积或标定总质量）
		
- **损失**（可多任务混合）
	- **Poisson NLL** 或 **KL**（适合计数/密度）
	- **Sinkhorn/EMD（近似地球移动距离）**：鼓励形状与位置对齐
	- **总变差 (TV) 正则**：抑制噪声、鼓励平滑
	- **质量守恒罚项**：$|\sum \hat M - V|$
		
- **数据增强**：与风向一致地旋转 (X,Y)、尺度抖动、时序裁剪（如只用释放前/后窗口）

## 3. 标注与评估

- **标注**：把地面照片/收集器读数栅格化为$H\times W$的面密度（单位统一）。
    
- **指标**（至少选 2–3 个）：
    - **EMD/Wasserstein 距离**（形状+位移敏感）
    - **KL/交叉熵** 或 **负对数似然**
    - **中心误差**（质心 $(x_c,y_c)$ 偏差）、**主轴误差**、**包含质量率**（如：预测 1σ 椭圆内包含真实质量的比例）
    - **质量守恒误差**：$|\sum \hat M - V|$

## 4 快速可行的两阶段实现（推荐落地版）

**阶段 1：强基线（小数据也能跑）**

1. 预处理：把风序列做方向对齐 + 统计/频谱特征；
    
2. 模型：MLP → 预测 **K=1** 的椭圆参数 (xc,yc,a,b,θ)(x_c,y_c,a,b,\theta)(xc​,yc​,a,b,θ) 与强度；
    
3. 训练：用 KL 或 MSE 拟合真实热力图（把参数生成的椭圆密度渲染到网格对比）；
    
4. 指标：中心/主轴误差 + 质量守恒。
    

**阶段 2：细节增强（中等数据）**

1. 在阶段 1 的基础上，接一个 **小 U‑Net** 预测**残差热力图**（细节纹理 + 非椭圆部分）；
    
2. 损失：残差用 Poisson/KL，整体加 EMD 与 TV；
    
3. 约束：最终图 = 椭圆渲染 + 残差，经 **Softplus** 与 **质量归一**。
    

> 这样既有物理解读（椭圆部分），也有数据驱动的精细刻画（残差）。

